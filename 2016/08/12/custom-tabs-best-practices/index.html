<!DOCTYPE html>
<html lang="null">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="赵元杰的技术博客">
    <title>Chrome Custom Tabs最佳实践 - 赵元杰的技术博客</title>
    <meta name="author" content="赵元杰">
    <meta name="description" content="赵元杰的技术博客">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="距离Google发布Chrome Custom Tabs已经一年，Twitter、Medium等国外App早已支持了这个功能，但遗憾的是国内App鲜有支持。这篇文章以官方开发文档和示例源码为基础，加上自己的理解，希望能帮助读者快速掌握Chrome Custom Tabs的用法。
为什么要用Chrome Custom Tabs？当App需要打开一个网站时，开发者面临两种选择：默认浏览器或WebVie">
<meta property="og:type" content="blog">
<meta property="og:title" content="Chrome Custom Tabs最佳实践">
<meta property="og:url" content="http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/index.html">
<meta property="og:site_name" content="赵元杰的技术博客">
<meta property="og:description" content="距离Google发布Chrome Custom Tabs已经一年，Twitter、Medium等国外App早已支持了这个功能，但遗憾的是国内App鲜有支持。这篇文章以官方开发文档和示例源码为基础，加上自己的理解，希望能帮助读者快速掌握Chrome Custom Tabs的用法。
为什么要用Chrome Custom Tabs？当App需要打开一个网站时，开发者面临两种选择：默认浏览器或WebVie">
<meta property="og:image" content="https://developer.chrome.com/multidevice/images/customtab/performance.gif">
<meta property="og:updated_time" content="2016-08-13T09:02:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chrome Custom Tabs最佳实践">
<meta name="twitter:description" content="距离Google发布Chrome Custom Tabs已经一年，Twitter、Medium等国外App早已支持了这个功能，但遗憾的是国内App鲜有支持。这篇文章以官方开发文档和示例源码为基础，加上自己的理解，希望能帮助读者快速掌握Chrome Custom Tabs的用法。
为什么要用Chrome Custom Tabs？当App需要打开一个网站时，开发者面临两种选择：默认浏览器或WebVie">
<meta name="twitter:creator" content="@qq157755587">
    
    
        
            <meta property="fb:admins" content="100007345843333" />
        
    
    
        <meta property="og:image" content="http://www.gravatar.com/avatar/f8ec0fb50db171bd93814bde2d3b9400?s=640"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-65290548-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">赵元杰的技术博客</a>
    </h1>
    
        <a class="header-right-picture" href="/#about">
            <img class="header-picture" src="http://www.gravatar.com/avatar/f8ec0fb50db171bd93814bde2d3b9400?s=90"/>
        </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
    <div class="sidebar-profile">
        <a href="/#about">
            
            <img class="sidebar-profile-picture" src="http://www.gravatar.com/avatar/f8ec0fb50db171bd93814bde2d3b9400?s=90"/>
            
        </a>
        <span class="sidebar-profile-name">赵元杰</span>
    </div>
    
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/ 
                    ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-categories
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-tags
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-archives
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link st-search-show-outputs"
                    href="/#search
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/#about
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About me</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://github.com/qq157755587" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://gist.github.com/qq157755587" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-github-square"></i>
                    <span class="sidebar-button-desc">Gist</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="http://stackoverflow.com/users/2298397" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-stack-overflow"></i>
                    <span class="sidebar-button-desc">Stack Overflow</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://twitter.com/qq157755587" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://www.facebook.com/profile.php?id=100007345843333" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://plus.google.com/u/0/114790614951350139361/posts" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-google-plus"></i>
                    <span class="sidebar-button-desc">Google +</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://www.linkedin.com/profile/view?id=267600087" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">Linked In</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="mailto:qq157755587@gmail.com" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/atom.xml
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>
            <div id="main" data-behavior="1">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
        <div class="post-header main-content-wrap">
    
        <h1 class="post-title" itemprop="headline">Chrome Custom Tabs最佳实践</h1>
    
    <div class="post-meta">
    <time  itemprop="datePublished" content="Fri Aug 12 2016 16:54:34 GMT+0800">
        Aug 12, 2016
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Android/">Android</a>


    
</div>
</div>
    
    <div class="post-content markdown main-content-wrap" itemprop="articleBody">
        
            <p>距离Google发布Chrome Custom Tabs已经一年，Twitter、Medium等国外App早已支持了这个功能，但遗憾的是国内App鲜有支持。这篇文章以官方<a href="https://developer.chrome.com/multidevice/android/customtabs" target="_blank" rel="external">开发文档</a>和<a href="https://github.com/GoogleChrome/custom-tabs-client" target="_blank" rel="external">示例源码</a>为基础，加上自己的理解，希望能帮助读者快速掌握Chrome Custom Tabs的用法。</p>
<h1 id="为什么要用Chrome_Custom_Tabs？">为什么要用Chrome Custom Tabs？</h1><p>当App需要打开一个网站时，开发者面临两种选择：默认浏览器或WebView。这两种选择都有不足。从App跳转到浏览器是一个非常重的切换，并且浏览器无法自定义；而WebView无法与浏览器共享cookies等数据，并且需要开发者处理非常多的场景。</p>
<p>Chrome Custom Tabs提供了一种新的选择，既能在App和网页之间流畅切换，又能有多种自定义选项。其实它本质上是调用了Chrome中的一个Activity来打开网页，这样想就能理解这些优点了。能自定义的项目有：</p>
<ul>
<li><p>Toolbar颜色</p>
</li>
<li><p>进场和出场动画</p>
</li>
<li><p>Toolbar上的action button，menu item和bottom toolbar（通过RemoveView实现）</p>
</li>
</ul>
<p>Chrome Custom Tabs还提供预启动Chrome和预加载网页内容的功能，与传统方式相比加载速度有显著提升。</p>
<p><img src="https://developer.chrome.com/multidevice/images/customtab/performance.gif" alt="alt"></p>
<h1 id="什么时候用Chrome_Custom_Tabs，什么时候用WebView？">什么时候用Chrome Custom Tabs，什么时候用WebView？</h1><p>如果Web页面是你自己的内容（比如淘宝商品页之于手机淘宝），那么WebView是最好的选择，因为你可能需要针对网页内容及用户操作做非常多的自定义。如果是跳到一个外部网站，比如在App中点了一个广告链接跳转到广告商的网站，那么建议使用Chrome Custom Tabs。</p>
<h1 id="前置条件">前置条件</h1><p>用户的手机上需要安装Chrome <strong>45</strong>或以上版本，并且<strong>设为默认浏览器</strong>。考虑到Chrome在国内手机上的占有率，这确实是个问题……但如果你的APP不只是面对国内市场，那么以Google在海外市场的影响力，这完全不是问题。</p>
<p>肯定有人要问，如果手机上没有装Chrome，调用Chrome Custom Tabs会发生什么行为呢？我们查看<code>CustomTabsIntent.Builder</code>的<a href="https://android.googlesource.com/platform/frameworks/support/+/c502e63/customtabs/src/android/support/customtabs/CustomTabsIntent.java#164" target="_blank" rel="external">源码</a>可以发现，Builder的内部构造了一个action为<code>Intent.ACTION_VIEW</code>的Intent，所以答案是调用默认浏览器来打开URL。</p>
<p>这时我们可以发现Chrome Custom Tabs的原理：如果Chrome是默认浏览器，那么这个Intent自然就会唤起Chrome，然后Chrome会根据Intent的各个Extra来配置前面所讲的自定义项。这里有一个隐藏的好处：<strong>如果你的工作恰好是开发浏览器，那么也可以根据这些Extra信息来定制界面！</strong></p>
<h1 id="开发向导">开发向导</h1><h2 id="快速上手">快速上手</h2><p>首先在你的<em>build.gradle</em>文件中加入dependency</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    compile <span class="string">'com.android.support:customtabs:24.1.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后写几行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">"https://www.google.com"</span>;</span><br><span class="line">CustomTabsIntent.Builder builder = <span class="keyword">new</span> CustomTabsIntent.Builder();</span><br><span class="line">CustomTabsIntent customTabsIntent = builder.build();</span><br><span class="line">customTabsIntent.launchUrl(<span class="keyword">this</span>, Uri.parse(url));</span><br></pre></td></tr></table></figure>
<p>就好了！不费吹灰之力~</p>
<p>注意launchUrl这个方法的第一个参数是个Activity。肯定有人会跳起来说，我要在ViewHolder里面处理点击跳转，根本拿不到Activity，只有Context肿么办？！！（其实这个人就是我）</p>
<p>那么我们看看launchUrl的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">launchUrl</span><span class="params">(Activity context, Uri url)</span> </span>&#123;</span><br><span class="line">    intent.setData(url);</span><br><span class="line">    ActivityCompat.startActivity(context, intent, startAnimationBundle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原来是为了传入startAnimationBundle这个参数来实现自定义转场动画。那么我们自己处理一下就好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">    customTabsIntent.launchUrl((Activity) context, uri);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Intent intent = customTabsIntent.intent;</span><br><span class="line">    intent.setData(uri);</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</span><br><span class="line">        context.startActivity(intent, customTabsIntent.startAnimationBundle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="修改Toolbar颜色">修改Toolbar颜色</h2><p>你一定希望Chrome Custom Tabs的Toolbar颜色与你自己APP的Toolbar颜色保持相同，看起来就像是在APP内打开网页一样。一行代码搞定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.setToolbarColor(colorInt);</span><br></pre></td></tr></table></figure>
<h2 id="添加action_button">添加action button</h2><p>你可能想要在Toolbar上加上action button，那么需要创建一个PendingIntent。下面的代码增加了一个发送邮件的action button：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Intent actionIntent = <span class="keyword">new</span> Intent(Intent.ACTION_SEND);</span><br><span class="line">actionIntent.setType(<span class="string">"*/*"</span>);</span><br><span class="line">actionIntent.putExtra(Intent.EXTRA_EMAIL, <span class="string">"example@example.com"</span>);</span><br><span class="line">actionIntent.putExtra(Intent.EXTRA_SUBJECT, <span class="string">"example"</span>);</span><br><span class="line">PendingIntent pi = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, actionIntent, <span class="number">0</span>);</span><br><span class="line">Bitmap icon = BitmapFactory.decodeResource(getResources(), R.drawable.ic_share);<span class="comment">//注意在正式项目中不要在UI线程读取图片</span></span><br><span class="line">builder.setActionButton(icon, <span class="string">"send email"</span>, pi, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="添加menu_item">添加menu item</h2><p>Chrome Custom Tabs的menu默认包含了三个显示为图标的item(Forward, Page Info, Refresh)和两个文字item(Find in page, Open in Browser)。我们可以再添加最多5个文字item。同样需要创建PendingIntent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent menuIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">menuIntent.setClass(getApplicationContext(), SomeActivity.class);</span><br><span class="line">PendingIntent pi = PendingIntent.getActivity(getApplicationContext(), <span class="number">0</span>, menuIntent, <span class="number">0</span>);</span><br><span class="line">builder.addMenuItem(<span class="string">"Menu entry 1"</span>, pi);</span><br></pre></td></tr></table></figure>
<h2 id="设置转场动画">设置转场动画</h2><p>如果你的APP设置了转场动画，那么为了统一的用户体验，可以在Chrome Custom Tabs中设置同样的动画</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder.setStartAnimations(<span class="keyword">this</span>, R.anim.slide_in_right, R.anim.slide_out_left);</span><br><span class="line">builder.setExitAnimations(<span class="keyword">this</span>, R.anim.slide_in_left, R.anim.slide_out_right);</span><br></pre></td></tr></table></figure>
<h2 id="预启动(Warm_up)_Chrome和预加载">预启动(Warm up) Chrome和预加载</h2><p>默认情况下，调用了<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsIntent.html#launchUrl" target="_blank" rel="external">CustomTabsIntent#launchUrl</a>方法之后，才会在后台启动（原文是spin up）Chrome，然后加载网页。这个过程会花费宝贵的时间，并影响到用户体验。要是能「秒开」网页那就爽了。Chrome Custom Tabs可以绑定Chrome的一个Service，绑定成功之后可以预启动Chrome，还可以让Chrome预加载一些网页（当然这是要消耗一些流量的）。大致的过程是这样的：</p>
<ul>
<li>通过<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsClient.html#bindCustomTabsService" target="_blank" rel="external">CustomTabsClient#bindCustomTabsService</a>方法绑定Service。绑定成功后会得到一个CustomTabsClient的instance。如果绑定失败，说明Chrome版本过低或者没有安装。</li>
<li>通过<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsClient.html#warmup" target="_blank" rel="external">CustomTabsClient#warmup</a>方法在后台启动Chrome。</li>
<li>通过<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsClient.html#newSession" target="_blank" rel="external">CustomTabsClient#newSession</a>方法创建一个新的session。这一步还可以传入一个<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsCallback.html" target="_blank" rel="external">CustomTabsCallback</a>参数用来得到session的状态，比如页面是否加载完成。</li>
<li>通过<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsSession.html#mayLaunchUrl" target="_blank" rel="external">CustomTabsSession#mayLaunchUrl</a>来告诉Chrome要预加载哪些网页。</li>
<li>当用户点击事件发生时，将前面那个session传入<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsIntent.Builder.html" target="_blank" rel="external">CustomTabsIntent.Builder</a>，然后用文章最开头的方法打开网页。</li>
</ul>
<p>下面是完成这个过程的简单代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">ServiceConnectionCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CustomTabsSession mSession;</span><br><span class="line">    <span class="keyword">private</span> CustomTabsClient mClient;</span><br><span class="line">    <span class="keyword">private</span> CustomTabsServiceConnection mConnection;</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindCustomTabsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mConnection = <span class="keyword">new</span> ServiceConnection(<span class="keyword">this</span>);</span><br><span class="line">        CustomTabsClient.bindCustomTabsService(<span class="keyword">this</span>, <span class="string">"com.android.chrome"</span>, mConnection);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">warmup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClient != <span class="keyword">null</span>) mClient.warmup(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">preLaunch</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClent != <span class="keyword">null</span> &amp;&amp; mSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSession = mClient.newSession(<span class="keyword">new</span> CustomTabsCallback(&#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNavigationEvent</span><span class="params">(<span class="keyword">int</span> navigationEvent, Bundle extras)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 这里可以取到Session的状态</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        mSession.mayLaunchUrl(Uri.parse(url), <span class="keyword">null</span>, <span class="keyword">null</span>);<span class="comment">//这里的第三个参数可以传入一些低优先级的Url，但不能保证会被预加载</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        CustomTabsIntent.Builder builder = <span class="keyword">new</span> CustomTabsIntent.Builder(mSession);</span><br><span class="line">        CustomTabsIntent customTabsIntent = builder.build();</span><br><span class="line">        customTabsIntent.launchUrl(<span class="keyword">this</span>, Uri.parse(url));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mConnection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            unbindService(mConnection);</span><br><span class="line">            mClient = <span class="keyword">null</span>;</span><br><span class="line">            mSession = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** ServiceConnectionCallback的回调方法 */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(CustomTabsClient client)</span> </span>&#123;</span><br><span class="line">        mClient = client;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mClient = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="简单的预启动">简单的预启动</h2><p>Android Support Library 24.0.0开始加入了<a href="https://developer.android.com/reference/android/support/customtabs/CustomTabsClient.html#connectAndInitialize" target="_blank" rel="external">CustomTabsClient#connectAndInitialize</a>方法来简化预启动代码。如果你无法预料到用户会打开哪个URL，或者出于省电的考虑不想预加载URL，那么可以在Activity的onStart中加入一行代码来预启动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomTabsClient.connectAndInitialize(<span class="keyword">this</span>, <span class="string">"com.android.chrome"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="最佳实践">最佳实践</h1><h2 id="绑定Custom_Tabs的service并预启动">绑定Custom Tabs的service并预启动</h2><p>预启动Chrome可以帮助你节省高达<strong>700ms</strong>的宝贵时间！这几乎是可以划分卡与不卡的差别。启动过程是在后台以低优先级进行，所以<strong>不会对你的APP性能有负面影响</strong>。</p>
<h2 id="预加载网页内容">预加载网页内容</h2><p>预加载网页后可以达到秒开的效果！所以如果你至少有50%的把握用户会打开某个URL，你应当调用<a href="http://developer.android.com/reference/android/support/customtabs/CustomTabsSession.html#mayLaunchUrl%28android.net.Uri,%20android.os.Bundle,%20java.util.List%3Candroid.os.Bundle%3E%29" target="_blank" rel="external">mayLaunchUrl()</a>方法。这个方法会提前下载并渲染网页内容，但不可避免的会有一点流量和电量的消耗。如果用户正在使用收费的数据流量，或者手机电量不足，那么这个方法不会生效。所以我们<strong>完全不用自己考虑性能优化</strong>。</p>
<h2 id="备选方案">备选方案</h2><p>如果用户的手机上没有安装Chrome，那么打开默认浏览器可能并不是最好的用户体验。所以如果在bindService那一步失败了，无论是打开默认浏览器还是WebView，选择一个你认为最好的备选方案。</p>
<h2 id="referrer">referrer</h2><p>很多网站都会统计自己的流量是从哪儿来的，所以最好告诉他们是你的帅气APP给他们带来了流量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(Intent.EXTRA_REFERRER, </span><br><span class="line">        Uri.parse(Intent.URI_ANDROID_APP_SCHEME + <span class="string">"//"</span> + context.getPackageName()));</span><br></pre></td></tr></table></figure>
<h2 id="加入自定义动画">加入自定义动画</h2><p>自定义的转场动画会让你的网页跳转更流畅。确保进场动画和出场动画是反向的，比如网页从右边进来，就从右边出去，这样能帮助用户理解跳转关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder.setStartAnimations(<span class="keyword">this</span>, R.anim.slide_in_right, R.anim.slide_out_left);</span><br><span class="line">builder.setExitAnimations(<span class="keyword">this</span>, R.anim.slide_in_left, R.anim.slide_out_right);</span><br></pre></td></tr></table></figure>
<h2 id="为Action_Button选个合适的图标">为Action Button选个合适的图标</h2><p>一个合适的图标能让用户快速的理解到APP的功能。但记住图标的最大尺寸是宽48dp高24dp。</p>
<h2 id="其他支持的浏览器">其他支持的浏览器</h2><p>前面有讲到其他浏览器也有机会支持Custom Tabs的功能（虽然我还没发现有哪款已经支持了）。如果你检测到不止一个浏览器支持Custom Tabs，那么第一次调用时最好询问用户打算用哪个浏览器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Returns a list of packages that support Custom Tabs.</span><br><span class="line"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList <span class="title">getCustomTabsPackages</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    PackageManager pm = context.getPackageManager();</span><br><span class="line">    <span class="comment">// Get default VIEW intent handler.</span></span><br><span class="line">    Intent activityIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, Uri.parse(<span class="string">"http://www.example.com"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get all apps that can handle VIEW intents.</span></span><br><span class="line">    List resolvedActivityList = pm.queryIntentActivities(activityIntent, <span class="number">0</span>);</span><br><span class="line">    ArrayList packagesSupportingCustomTabs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ResolveInfo info : resolvedActivityList) &#123;</span><br><span class="line">        Intent serviceIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">        serviceIntent.setAction(ACTION_CUSTOM_TABS_CONNECTION);</span><br><span class="line">        serviceIntent.setPackage(info.activityInfo.packageName);</span><br><span class="line">        <span class="comment">// Check if this package also resolves the Custom Tabs service.</span></span><br><span class="line">        <span class="keyword">if</span> (pm.resolveService(serviceIntent, <span class="number">0</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            packagesSupportingCustomTabs.add(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packagesSupportingCustomTabs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="给用户选择权">给用户选择权</h2><p>如果你的APP之前一直是用默认浏览器打开URL，后来才加入的Custom Tabs，那么老用户可能希望保留原来的习惯。可以考虑在设置里面增加一个选项，让用户自行选择。</p>
<h2 id="尽量让Native_APP处理URL">尽量让Native APP处理URL</h2><p>有些URL可以由Native APP处理。如果用户安装了Twitter的APP并且点击了Twitter的URL，他可能更期望用Twitter APP打开。所以在打开URL之前，检查看看手机里有没有其他APP可以处理这个URL。</p>
<h2 id="自定义Toolbar颜色">自定义Toolbar颜色</h2><p>如果你希望用户觉得网页内容是你的APP的一部分，那么就将Toolbar颜色设为你的primaryColor。如果希望清除的表明网页内容与APP无关，那么选个不同的颜色吧。</p>
<h2 id="增加一个分享按钮">增加一个分享按钮</h2><p>用户可能想要把URL分享给好友，但Custom Tabs默认并没有分享按钮，所以最好自己加个吧。</p>
<h2 id="自定义关闭按钮">自定义关闭按钮</h2><p>Custom Tabs左上角的关闭按钮默认是一个叉叉。如果你希望用户感觉到网页内容是APP的一部分，那么最好把叉叉换成返回按钮。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.setCloseButtonIcon(BitmapFactory.decodeResource(getResources(), R.drawable.ic_arrow_back));</span><br></pre></td></tr></table></figure>
<h2 id="分清内部链接和外部链接">分清内部链接和外部链接</h2><p>举个例子，如果用户在Twitter APP里点击了一个<code>http://twitter.com</code>开头的URL，那么应该在APP内部处理。Custom Tabs只应用来处理外部链接。</p>
<h2 id="处理连击">处理连击</h2><p>如果你想在用户点击URL到打开Custom Tabs之间的这段时间做一点准备工作，确保不要超过100ms，否则用户可能会觉得APP没有反应而再次点击。</p>
<p>然而你懂的在Android上是无法完全避免卡顿的，所以当用户反复点击同一个URL时，你应该只将URL打开一次。</p>
<h1 id="结尾">结尾</h1><p>如果你的APP是使用默认浏览器打开URL，那么身为一个合格的开发者，即使你的APP只在国内上架，也应该加入Custom Tabs支持。毕竟国内还是有一些会科学上网的用户使用Chrome的。更重要的是，<strong>我们这些开发者如果看到有国内APP使用了Custom Tabs，会欣慰的点个赞！</strong></p>

        
        
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/chrome/">chrome</a> <a class="tag tag--primary tag--small t-link" href="/tags/customtabs/">customtabs</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/14/kotlin-in-android/" data-tooltip="Kotlin在Android中的应用">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 赵元杰. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/14/kotlin-in-android/" data-tooltip="Kotlin在Android中的应用">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://qq157755587.github.io/2016/08/12/custom-tabs-best-practices/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="http://www.gravatar.com/avatar/f8ec0fb50db171bd93814bde2d3b9400?s=110"/>
        
            <h4 id="about-card-name">赵元杰</h4>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Andoird工程师</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Wuhan
            </h5>
        
    </div>
</div>
        <div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'zhaoyuanjie';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','SU2oWudfBg2KDR_wiXjF','2.0.0');
    </script>


</html>
